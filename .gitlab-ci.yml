image: acastellano/cirunnerdaedaluscore

stages:
    - test
    - coverage

integration_tests:
    stage: test
    image: daedalusproject/base_kubectl:201904071145
    before_script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-core-deployer --token=$KUBE_DEVELOP_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-core-deployer
        - kubectl config use-context default
        - kubectl -n daedalus-core-develop delete -f kubernetes/daedalus-core-develop/dev-environment.yml --ignore-not-found=true
        - kubectl -n daedalus-core-develop delete configmap redis-config --ignore-not-found=true
        - kubectl -n daedalus-core-develop delete configmap rabbitmq-config --ignore-not-found=true
        - kubectl -n daedalus-core-develop create configmap redis-config --from-file kubernetes/config/redis.conf
        - kubectl -n daedalus-core-develop create configmap rabbitmq-config --from-file kubernetes/config/rabbitmq
        - kubectl -n daedalus-core-develop apply -f kubernetes/daedalus-core-develop/dev-environment.yml
        - apt-get update
        - apt-get install -y redis-tools golang golang-github-streadway-amqp-dev cpanminus
        - apt-get install -y libcatalyst-perl libcatalyst-plugin-configloader-perl libcatalyst-plugin-static-simple-perl libcatalyst-action-renderview-perl libcatalyst-view-tt-perl libcatalyst-view-json-perl libcatalyst-plugin-unicode-perl libcatalyst-plugin-authentication-perl libcatalyst-plugin-authorization-roles-perl libnamespace-autoclean-perl libmoose-perl libmoosex-nonmoose-perl libconfig-general-perl libcatalyst-model-adaptor-perl libmoosex-markasmethods-perl libcatalyst-modules-perl libcatalyst-modules-extra-perl libtext-csv-xs-perl libmodule-install-perl libcatalyst-model-adaptor-perl libdbix-class-encodedcolumn-perl libcatalyst-controller-formbuilder-perl libconfig-zomg-perl libterm-readkey-perl libstring-random-perl libdata-password-perl libdbix-class-timestamp-perl libcatalyst-authentication-store-dbix-class-perl libcatalyst-action-rest-perl libdata-password-check-perl libdbix-class-validation-perl libdatetime-format-sqlite-perl libdaedalus-hermes-perl libcatalyst-plugin-configloader-multi-perl libcrypt-jwt-perl libdatetime-format-mysql-perl libnumber-phone-perl libcatalyst-plugin-cache-perl libredis-perl libcache-redis-perl
        - export GOPATH=/usr/share/gocode
    script:
        - echo "Hello" | redis-cli -h redis-daedalus-core-develop -x set greeting
        - redis-cli -h redis-daedalus-core-develop get greeting
        - go run kubernetes/utils/send.go
        - go run kubernetes/utils/receive.go
        - perl --version
        - cd t && cpanm --quiet --installdeps --notest . && cd ..
        - perl script/deploy.pl SQLite /var/tmp/daedalus_core_realms.db
        - perl t/script/populate_test_database.pl
        - perl Makefile.PL
        - make
        - make test
    after_script:
        - kubectl -n daedalus-core-develop delete -f kubernetes/daedalus-core-develop/dev-environment.yml
        - kubectl -n daedalus-core-develop delete configmap redis-config
        - kubectl -n daedalus-core-develop delete configmap rabbitmq-config --ignore-not-found=true

cover:
    stage: coverage
    image: daedalusproject/base_kubectl:201904071145
    before_script:
        - kubectl config set-cluster default --server=$KUBE_URL --certificate-authority=kubernetes/windmaker.pem
        - kubectl config set-credentials gitlab-daedalus-core-deployer --token=$KUBE_DEVELOP_USER_TOKEN
        - kubectl config set-context default --cluster=default --user=gitlab-daedalus-core-deployer
        - kubectl config use-context default
        - kubectl -n daedalus-core-develop delete -f kubernetes/daedalus-core-develop/dev-environment.yml --ignore-not-found=true
        - kubectl -n daedalus-core-develop delete configmap redis-config --ignore-not-found=true
        - kubectl -n daedalus-core-develop delete configmap rabbitmq-config --ignore-not-found=true
        - kubectl -n daedalus-core-develop create configmap redis-config --from-file kubernetes/config/redis.conf
        - kubectl -n daedalus-core-develop create configmap rabbitmq-config --from-file kubernetes/config/rabbitmq
        - kubectl -n daedalus-core-develop apply -f kubernetes/daedalus-core-develop/dev-environment.yml
        - apt-get update
        - apt-get install -y redis-tools golang golang-github-streadway-amqp-dev cpanminus
        - apt-get install -y libcatalyst-perl libcatalyst-plugin-configloader-perl libcatalyst-plugin-static-simple-perl libcatalyst-action-renderview-perl libcatalyst-view-tt-perl libcatalyst-view-json-perl libcatalyst-plugin-unicode-perl libcatalyst-plugin-authentication-perl libcatalyst-plugin-authorization-roles-perl libnamespace-autoclean-perl libmoose-perl libmoosex-nonmoose-perl libconfig-general-perl libcatalyst-model-adaptor-perl libmoosex-markasmethods-perl libcatalyst-modules-perl libcatalyst-modules-extra-perl libtext-csv-xs-perl libmodule-install-perl libcatalyst-model-adaptor-perl libdbix-class-encodedcolumn-perl libcatalyst-controller-formbuilder-perl libconfig-zomg-perl libterm-readkey-perl libstring-random-perl libdata-password-perl libdbix-class-timestamp-perl libcatalyst-authentication-store-dbix-class-perl libcatalyst-action-rest-perl libdata-password-check-perl libdbix-class-validation-perl libdatetime-format-sqlite-perl libdaedalus-hermes-perl libcatalyst-plugin-configloader-multi-perl libcrypt-jwt-perl libdatetime-format-mysql-perl libnumber-phone-perl libcatalyst-plugin-cache-perl libredis-perl libcache-redis-perl
        - export GOPATH=/usr/share/gocode
    script:
        - echo "Hello" | redis-cli -h redis-daedalus-core-develop -x set greeting
        - redis-cli -h redis-daedalus-core-develop get greeting
        - go run kubernetes/utils/send.go
        - go run kubernetes/utils/receive.go
        - perl --version
        - cd t && cpanm --quiet --installdeps --notest . && cd ..
        - perl script/deploy.pl SQLite /var/tmp/daedalus_core_realms.db
        - perl t/script/populate_test_database.pl
        - perl Makefile.PL
        - make
        - cover -test
        - cover -report codecov
    coverage: /Total\s+.+\s(\d+\.\d+?)$/
    after_script:
        - kubectl -n daedalus-core-develop delete -f kubernetes/daedalus-core-develop/dev-environment.yml
        - kubectl -n daedalus-core-develop delete configmap redis-config
        - kubectl -n daedalus-core-develop delete configmap rabbitmq-config --ignore-not-found=true
